<?xml version="1.0" encoding="UTF-8" ?>
<Module>
	<ModulePrefs title="BasketDB Gadget" 
		author="Kob" height="500">
		<Require feature="pubsub-2">
			<Param name="topics">
				<Topic title="GFBio BasketDB" name="gfbio.search.basketdb"
					description="Interaction with Basket DB" type="string" subscribe="true" publish="true" />
			</Param>
		</Require>
		<Require feature="dynamic-height" />
	</ModulePrefs>
	<Content type="html">
	<![CDATA[
	<!DOCTYPE html>
		<html>
			<head>
				<title>Interaction with Basket DB</title>
				<script src="http://gfbio-dev1.inf-bb.uni-jena.de/gfbio/search/js/jquery-1.10.2.js"	type="text/javascript"></script>
				<script src="http://gfbio-dev1.inf-bb.uni-jena.de/gfbio/search/js/jquery-1.10.2-ui.js"	type="text/javascript"></script>
				<script type="text/javascript">
			
				    function addBasket(){
    				    var uid = parent.Liferay.ThemeDisplay.getUserId();
    					console.log(uid);
    					var basketid = 0;
    					var name = document.getElementById("basket_name").value;
    					var val = document.getElementById("basket_val").value;
    					var query = document.getElementById("basket_query").value;
    					parent.Liferay.Service(
                          '/GFBioProject-portlet.basket/update-basket',
                          {
                            basketID: basketid,
                            userID: uid,
                            name: name,
                            basketJSON: val,
                            queryJSON: query
                          },
                          function(obj){
							displayResult(obj);
						  }
						);
				    }
				    function getBasket(){
    					var getOption = document.getElementById("getByOption");
    					var getOptionSelVal = getOption.options[getOption.selectedIndex].value;
    					var id = document.getElementById("getID").value;
        				var uid = parent.Liferay.ThemeDisplay.getUserId();
    					var getPeriod = document.getElementById("getPeriodOption");
    					var getPeriodSelVal = getPeriod.options[getPeriod.selectedIndex].value;
    					
    					var url = "";
    					var param = null;
    					if (getOptionSelVal == "getByCurrentUserId"){
    					    if (getPeriodSelVal > 0){
    					        url = "/GFBioProject-portlet.basket/get-baskets-by-user-and-period";
    					        param = {"userID":uid, "period":getPeriodSelVal};
        					}
        					else{
            					url = "/GFBioProject-portlet.basket/get-baskets-by-user-id";
            					param = {'userID':uid};
            				}
    					}
						else if (getOptionSelVal == "getIdsByCurrentUserId"){
    					    if (getPeriodSelVal > 0){
    					        url = "/GFBioProject-portlet.basket/get-baskets-id-by-user-and-period";
    					        param = {"userID":uid, "period":getPeriodSelVal};
        					}
        					else{
        					    url = "/GFBioProject-portlet.basket/get-baskets-id-by-user-id";
        					    param = {'userID':uid};
        					}
    					}
						else if (getOptionSelVal == "getByUserId"){
    					    if (getPeriodSelVal > 0){
    					        url = "/GFBioProject-portlet.basket/get-baskets-by-user-and-period";
    					        param = {"userID":id, "period":getPeriodSelVal};
        					}
        					else{
            					url = "/GFBioProject-portlet.basket/get-baskets-by-user-id";
    							// use id provided in input text
            					param = {'userID':id};
        					}
    					}
						else if (getOptionSelVal == "getIdsByUserId"){
    					    if (getPeriodSelVal > 0){
    					        url = "/GFBioProject-portlet.basket/get-baskets-id-by-user-and-period";
    					        param = {"userID":id, "period":getPeriodSelVal};
        					}
        					else{
            					url = "/GFBioProject-portlet.basket/get-baskets-id-by-user-id";
    							// use id provided in input text
            					param = {'userID':id};
            				}
    					}
						else if (getOptionSelVal == "getByBasketId"){
        					url = "/GFBioProject-portlet.basket/get-basket-by-id";
							// use id provided in input text
        					param = {'basketID':id};
    					}
						else if (getOptionSelVal == "getByBasketIds"){
        					url = "/GFBioProject-portlet.basket/get-baskets-by-ids";
							// use ids provided in input text
        					param = {'basketIds':id.split(",")};
    					}
    					
    					parent.Liferay.Service(
                            url,
                            param,
                            function(obj){
							    displayResult(obj);
							}
                        );
				    }
				    
				    function removeBasket(){
    					var basketid = document.getElementById("basket_id").value;
    					console.log(basketid);
    					parent.Liferay.Service(
                          '/GFBioProject-portlet.basket/remove-basket',
                          {
                            basketID: basketid
                          }, 
                          function(obj){
							displayResult(obj);
						   }
                        );
				    }
				    
				    function displayResult(obj){
                            var objStr = JSON.stringify(obj);
                            console.log(objStr);
                            var displaytext = objStr;
            				var div = document.getElementById('basket_result');
            				div.innerHTML = displaytext;
            				document.getElementById("basket_id").value = '';
            				adjust();
				    }
				    
    				function getByOptionChange() {
    				    console.log('get by option changed');
                        var selection = document.getElementById("getByOption").value; 
                        console.log(selection);
                        //grab the value selected
                        var periodOption = document.getElementById("getPeriodOption");
                        // disable period option for get by basket id functions
                        if ( (selection == "getByBasketId") || 
                            (selection == "getByBasketIds") ){
                            periodOption.value = 0;
                            periodOption.disabled=true;
                            // change text in getID box for hinting
                            if (selection == "getByBasketId"){
                                document.getElementById("getID").placeholder = "e.g. 101"; 
                            }else{
                                document.getElementById("getID").placeholder = "e.g. 101,102,103"; 
                            }
                        }
                        else{
                            document.getElementById("getID").placeholder = "e.g. 101"; 
                            periodOption.disabled=false;
                        }
                    }
                    
    				function adjust() {
    				   //console.log('auto adjust height');
    				   var height = $('#basket_div').height()+20;
    				   if (height < 350){ 
    						height = 350;
    				   }
    					gadgets.window.adjustHeight(height);
    				}
				</script>
			</head>
			<body>
			    <div id="basket_div">
			        <form id="add_basket">
                        <fieldset>
                            <legend>Add Basket:</legend>
        			        <input id="basket_name" 
        						type="text" placeholder="Name"
        						style="width:100%"/> <br/>
        			        <input id="basket_val" 
        						type="text" placeholder="Selected Value"
        						style="width:100%"/> <br/>
        			        <input id="basket_query" 
        						type="text" placeholder="Query String"
        						style="width:100%"/> <br/>
            				<input id="UpdateButton"
        						type="button" value="Add" 
        						onclick="javascript:addBasket();" />
        				</fieldset>
    			    </form>
			        <form id="get_basket">
                        <fieldset>
                            <legend>Get Basket:</legend>
        				    <select id="getByOption" onchange="getByOptionChange()">
                              <option value="getByCurrentUserId" selected>By Current User ID</option>
                              <option value="getIdsByCurrentUserId">IDs By Current User ID</option>
                              <option value="getByUserId">By User ID</option>
                              <option value="getIdsByUserId">IDs By User ID</option>
                              <option value="getByBasketId">By Basket ID</option>
                              <option value="getByBasketIds">By Multiple Basket IDs</option>
                            </select> 
                            
                            <input id="getID" 
        						type="text" placeholder="ID(s)"
        						autocomplete="off"/> 
        						
        					<br/>
        					Last updated:
        				    <select id="getPeriodOption">
                              <option value="0" selected>All</option>
                              <option value="1">Today</option>
                              <option value="2">2 days</option>
                              <option value="10">1 week</option>
                              <option value="50">2 weeks</option>
                              <option value="100">1 month</option>
                              <option value="200">2 months</option>
                              <option value="300">3 month</option>
                              <option value="600">6 months</option>
                              <option value="1000">1 year</option>
                              <option value="2000">2 years</option>
                              <option value="3000">3 years</option>
                            </select> 
                            <input id="GetButton"
        						type="button" value="Get Basket"
        						onclick="javascript:getBasket();" />
                        </fieldset>
    			    </form>
			        <form id="del_basket">
                        <fieldset>
                            <legend>Delete Basket:</legend>
                            Basket id:
        			        <input id="basket_id" 
        						type="text" placeholder="Basket ID"
        						autocomplete="off"/> 
            				<input id="RemoveButton"
        						type="button" value="Remove" 
        						onclick="javascript:removeBasket();" />
                        </fieldset>
    			    </form>
    			    </br>
    			    </br>
    			    <div id="basket_result" style="overflow-y: scroll;">
    			    </div>
    			 </div>
			</body>
		</html>
	]]>
	</Content>
</Module>